{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Projects/dealswindfall/nextjs-boilerplate/lib/supabaseAdmin.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\r\n\r\nexport const supabaseAdmin = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.SUPABASE_SERVICE_ROLE_KEY!, // server-only\r\n  { auth: { persistSession: false } }\r\n);\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,MAAM,gBAAgB,IAAA,yMAAY,gFAEvC,QAAQ,GAAG,CAAC,yBAAyB,EACrC;IAAE,MAAM;QAAE,gBAAgB;IAAM;AAAE","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///C:/Projects/dealswindfall/nextjs-boilerplate/app/api/deals/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { supabaseAdmin } from \"@/lib/supabaseAdmin\";\r\n\r\n/* -------------------------------------------------------------------------- */\r\n/* üîß Helpers                                                                  */\r\n/* -------------------------------------------------------------------------- */\r\n\r\n// Extract URLs from notes\r\nfunction extractUrls(text: string) {\r\n  return text?.match(/https?:\\/\\/[^\\s]+/g) || [];\r\n}\r\n\r\n// Get base URL (VERY IMPORTANT!)\r\nfunction getBaseUrl() {\r\n  return (\r\n    process.env.NEXT_PUBLIC_SITE_URL ||\r\n    process.env.NEXT_PUBLIC_VERCEL_URL ||\r\n    \"http://localhost:3000\"\r\n  );\r\n}\r\n\r\n// Fetch title from internal route (safe server version)\r\nasync function getTitle(url: string) {\r\n  try {\r\n    const base = getBaseUrl();\r\n\r\n    const res = await fetch(`${base}/api/fetch-title`, {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({ url }),\r\n    });\r\n\r\n    if (!res.ok) return null;\r\n\r\n    const data = await res.json();\r\n    return data.title || null;\r\n  } catch (err) {\r\n    console.error(\"‚ùå getTitle failed:\", err);\r\n    return null;\r\n  }\r\n}\r\n\r\n/* -------------------------------------------------------------------------- */\r\n/* üü¢ CREATE a new deal (POST)                                                 */\r\n/* -------------------------------------------------------------------------- */\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const body = await req.json();\r\n\r\n    // Parse prices\r\n    const oldP = parseFloat(body.old_price || body.oldPrice || 0);\r\n    const currP = parseFloat(body.current_price || body.currentPrice || 0);\r\n    const priceDiff = oldP && currP ? oldP - currP : 0;\r\n    const percentDiff = oldP ? Number(((priceDiff / oldP) * 100).toFixed(2)) : 0;\r\n\r\n    // Determine deal heat level\r\n    let dealLevel = \"\";\r\n    if (percentDiff >= 40 && percentDiff < 51) dealLevel = \"Blistering deal\";\r\n    else if (percentDiff >= 51 && percentDiff < 61) dealLevel = \"Scorching deal\";\r\n    else if (percentDiff >= 61 && percentDiff < 71) dealLevel = \"Searing deal\";\r\n    else if (percentDiff >= 71) dealLevel = \"Flaming deal\";\r\n\r\n    /* --------------------------------------------- */\r\n    /* STEP 1 ‚Äî Save the MAIN DEAL                  */\r\n    /* --------------------------------------------- */\r\n\r\n    const { data: deal, error } = await supabaseAdmin\r\n      .from(\"deals\")\r\n      .insert({\r\n        description: body.description || \"\",\r\n        current_price: currP || null,\r\n        old_price: oldP || null,\r\n        price_diff: priceDiff || null,\r\n        percent_diff: percentDiff || null,\r\n        image_link: body.imageLink || null,\r\n        product_link: body.productLink || null,\r\n        review_link: body.reviewLink || null,\r\n        coupon_code: body.couponCode || null,\r\n        shipping_cost: body.shippingCost\r\n          ? Number(body.shippingCost)\r\n          : null,\r\n        notes: body.notes || null,\r\n        expire_date: body.expireDate || null,\r\n        category: body.category || null,\r\n        store_name: body.storeName || null,\r\n        deal_level: dealLevel,\r\n        holiday_tag: body.holidayTag || null,\r\n        published_at: new Date().toISOString(),\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (error) throw error;\r\n\r\n    /* --------------------------------------------- */\r\n    /* STEP 2 ‚Äî Extract URLs from notes             */\r\n    /* --------------------------------------------- */\r\n\r\n    const urls = extractUrls(body.notes || \"\");\r\n\r\n    if (urls.length > 0) {\r\n      // Fetch all titles in parallel (MUCH faster)\r\n      const titleResults = await Promise.all(urls.map((u) => getTitle(u)));\r\n\r\n      const rows = urls.map((url, i) => ({\r\n        deal_id: deal.id,\r\n        url,\r\n        title: titleResults[i] || null,\r\n      }));\r\n\r\n      /* -------------------------------------------- */\r\n      /* STEP 3 ‚Äî Insert related links               */\r\n      /* -------------------------------------------- */\r\n\r\n      const { error: relErr } = await supabaseAdmin\r\n        .from(\"deal_related_links\")\r\n        .insert(rows);\r\n\r\n      if (relErr) console.error(\"‚ùå Related links insert failed:\", relErr);\r\n    }\r\n\r\n    return NextResponse.json({ ok: true, deal }, { status: 201 });\r\n  } catch (e: any) {\r\n    console.error(\"POST /deals error:\", e);\r\n    return NextResponse.json(\r\n      { error: e.message || \"Unknown error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/* -------------------------------------------------------------------------- */\r\n/* üìã GET all deals                                                            */\r\n/* -------------------------------------------------------------------------- */\r\nexport async function GET() {\r\n  try {\r\n    const { data, error } = await supabaseAdmin\r\n      .from(\"deals\")\r\n      .select(\"*\")\r\n      .order(\"published_at\", { ascending: false });\r\n\r\n    if (error) throw error;\r\n\r\n    return NextResponse.json(data || [], { status: 200 });\r\n  } catch (e: any) {\r\n    console.error(\"GET /deals error:\", e);\r\n    return NextResponse.json(\r\n      { error: e.message || \"Unknown error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n/* -------------------------------------------------------------------------- */\r\n/* ‚úèÔ∏è UPDATE existing deal (PUT)                                               */\r\n/* -------------------------------------------------------------------------- */\r\nexport async function PUT(req: Request) {\r\n  try {\r\n    const body = await req.json();\r\n    const { id, ...updateFields } = body;\r\n\r\n    if (!id) throw new Error(\"Missing deal ID for update.\");\r\n\r\n    // Recalculate discount if prices provided\r\n    const oldP = parseFloat(updateFields.old_price || 0);\r\n    const currP = parseFloat(updateFields.current_price || 0);\r\n\r\n    if (!isNaN(oldP) && !isNaN(currP) && oldP > 0 && currP > 0) {\r\n      const priceDiff = oldP - currP;\r\n      const percentDiff = Number(((priceDiff / oldP) * 100).toFixed(2));\r\n\r\n      let dealLevel = \"\";\r\n      if (percentDiff >= 40 && percentDiff < 51) dealLevel = \"Blistering deal\";\r\n      else if (percentDiff >= 51 && percentDiff < 61)\r\n        dealLevel = \"Scorching deal\";\r\n      else if (percentDiff >= 61 && percentDiff < 71)\r\n        dealLevel = \"Searing deal\";\r\n      else if (percentDiff >= 71) dealLevel = \"Flaming deal\";\r\n\r\n      updateFields.price_diff = priceDiff;\r\n      updateFields.percent_diff = percentDiff;\r\n      updateFields.deal_level = dealLevel;\r\n    }\r\n\r\n    // Update in Supabase\r\n    const { data, error } = await supabaseAdmin\r\n      .from(\"deals\")\r\n      .update(updateFields)\r\n      .eq(\"id\", id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) throw error;\r\n\r\n    return NextResponse.json({ ok: true, updated: data }, { status: 200 });\r\n  } catch (e: any) {\r\n    console.error(\"PUT /deals error:\", e);\r\n    return NextResponse.json(\r\n      { error: e.message || \"Unknown error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\nexport async function DELETE(req: Request) {\r\n  try {\r\n    const { id } = await req.json();\r\n    if (!id) throw new Error(\"Missing deal ID\");\r\n\r\n    console.log(\"üóë Deleting related links for deal:\", id);\r\n\r\n    // 1Ô∏è‚É£ Delete related links first (safe even if cascade exists)\r\n    const relDelete = await supabaseAdmin\r\n      .from(\"deal_related_links\")\r\n      .delete()\r\n      .eq(\"deal_id\", id);\r\n\r\n    if (relDelete.error) {\r\n      console.error(\"‚ùå Failed deleting related links:\", relDelete.error);\r\n      throw relDelete.error;\r\n    }\r\n\r\n    console.log(\"üóë Deleting deal:\", id);\r\n\r\n    // 2Ô∏è‚É£ Now delete the deal\r\n    const dealDelete = await supabaseAdmin\r\n      .from(\"deals\")\r\n      .delete()\r\n      .eq(\"id\", id);\r\n\r\n    if (dealDelete.error) {\r\n      console.error(\"‚ùå Failed deleting deal:\", dealDelete.error);\r\n      throw dealDelete.error;\r\n    }\r\n\r\n    return NextResponse.json(\r\n      { ok: true, message: \"Deal deleted\" },\r\n      { status: 200 }\r\n    );\r\n\r\n  } catch (err: any) {\r\n    console.error(\"üî• DELETE /deals crashed:\", err);\r\n    return NextResponse.json(\r\n      { error: err.message || \"Unknown delete error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}